<div class="row-fluid">
  <div class="span8">
    <h1><%= @stream.name %></h1>
  </div>
  <div class="span4">
    <p class="pull-right">Owned by <%= link_to @stream.user, @stream.user %></p>
  </div>
</div>


<div class="row-fluid">
  <div class="span4">
    <div class="tabs">
      <ul class="nav nav-tabs">
        <li class="active"><a href="#stream-items" data-toggle="tab">Items</a></li>
        <li><a href="#settings" data-toggle="tab">Fork Me!</a></li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane active" id="stream-items">
          <div id="stream-pins">
            <% unless @stream.pins.empty? %>
              <% last_date = @stream.pins.first.display_date %>
              <% first_date = last_date %>
              <div class="date"><%= "Day #{(last_date - first_date).to_i + 1}" %></div>
            <% end %>
            <% @stream.pins.each do |pin| %>
              <% if pin.display_date.to_date > last_date.to_date %>
                <% last_date = pin.display_date %>
                <div class="date">
                  <%= "Day #{((last_date - first_date)/86400).to_i + 1}"  %>
                </div>
              <% end %>
              <div class="row-fluid">
                <div class="span2 pin-micro">
                  <img src="<%= pin.item.thumb_url %>">
                </div>
                <div class="span10">
                  <%= link_to pin.item.name, stream_stream_pin_path(@stream, pin), remote: true %>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <div class="tab-pane" id="settings">
          <h2>Learn about <%= @stream.name %></h2>
          <% unless @stream.sources.empty? %>
            <p>
            Copying items from 
            <% @stream.sources.each do |source| %>
              <%= link_to source.name, source %>
            <% end %>
            </p>
          <% end %>

          <% if current_user %>
            <p>
            <% unless @stream.targets.where('user_id = ?', current_user).empty? %>
              This stream is currently forked to 
              <ul>
                <% @stream.targets.where('user_id = ?', current_user).each do |target| %>
                  <li><%= link_to target.name, target %></li>
                <% end %>
              </ul>
            <% else %>
              <% if @stream.user != current_user %>
                You aren't learning <%= @stream.name %> yet! You can start receiving its items in one of your own streams.
              <% end %>
            <% end %>
            </p>
          <% end %>


          <% if current_user %>
            <%= form_for [@stream, Fork.new], class: 'form-inline' do |f| %>
              <div class="control-group">
                <%= f.label :target_id, "Copy current and future items to one of your existing streams:", class: 'control-label' %>
                <div class="controls">
                  <%= f.select :target_id, current_user.streams.reject { |s| s == @stream }.collect {|s| [s.name, s.id]}, {:class => "input-medium" } %>
                </div>
              </div>
              <div class="control-group">
                <p>or into a new stream</p>
                <%= text_field_tag :new_stream, nil, placeholder: "stream name" %>
              </div>
              <%= f.submit 'Create fork', class: 'btn btn-primary' %>
            <% end %>
          <% end %>

        </div>

      </div>
    </div>
  </div>

  <div class="span8" id="item-area">
    <%= render :partial => 'pins/stream_pin',  :locals => { :pin => @stream.pins.first }  %>
  </div>
</div>




