<div class="row-fluid">
  <div class="stream-header span8">
    <h1 class="stream-name"><%= @stream.name %></h1>
    <% if current_user %>
      <div class="fork-form">
        <%= form_for [@stream, Fork.new], remote: true, :html => { :class => 'form-inline'} do |f| %>
          <div><%= f.hidden_field :target_id %></div>
          <div class="fork-block">
            <strong class="fork-label">Fork this stream into...</strong>
            <div class="btn-group pull-right">
              <button id="fork-button-popover" rel="popover" data-content="<p>Forking this stream will send all of its items into a stream of your own. It's an excellent way to collect and learn items from many sources!</p>" data-original-title="What's a fork?" class="btn btn-small no-click">select a stream...</button>
              <a  class="btn dropdown-toggle" data-toggle="dropdown">
                <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                <% current_user.streams.each do |s| %>
                  <% if s.sources.include?(@stream) %>
                    <li><a data-stream="<%= s.id %>" class="disabled" href="#"><i class="icon-random"></i> <%= s.name %></a></li>
                  <% else %>
                    <li><%= image_tag "ajax-loader.gif", :class => "hidden" %><a data-stream="<%= s.id %>" href="#"><%= s.name %></a></li>
                  <% end %>
                <% end %>
                <li class="divider"></li>
                <li><%= text_field_tag :new_stream, nil, :placeholder => "new stream", :class => "dropdown-input-field", :style => "margin-left: 10px; margin-bottom: 2px; width: 120px;"  %></li>
              </ul>
            </div>
          </div>
        <% end %>
        <a id="fork-notification" href="#" >Forked! Visit stream...</a>
      </div>
    <% end %>
  </div>


  <div class="span4">
    <p class="pull-right">Owned by <%= link_to @stream.user, @stream.user %></p>
  </div>
</div>


<div class="row-fluid">
  <div class="span4">
    <div class="tabs">
      <ul class="nav nav-tabs">
        <li class="active"><a href="#stream-items" data-toggle="tab">Items</a></li>
        <li><a href="#settings" data-toggle="tab">Forks</a></li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane active" id="stream-items">
          <div id="stream-pins">
            <% unless @stream.pins.empty? %>
              <% last_date = @stream.pins.first.display_date %>
              <% first_date = last_date %>
              <div class="date"><%= "Day #{(last_date - first_date).to_i + 1}" %></div>
            <% end %>
            <% @stream.pins.each do |pin| %>
              <% if pin.display_date.to_date > last_date.to_date %>
                <% last_date = pin.display_date %>
                <div class="date">
                  <%= "Day #{((last_date - first_date)/86400).to_i + 1}"  %>
                </div>
              <% end %>
              <div class="row-fluid item-task" data-id="<%= pin.id %>">
                <div class="span2 pin-micro">
                  <img src="<%= pin.item.thumb_url %>">
                </div>
                <div class="span10">
                  <%= link_to pin.item.name, stream_stream_pin_path(@stream, pin), { :remote => true, 'data-pin' => pin.id, 'data-stream' => @stream.id, :class => 'pin-link' } %>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <div class="tab-pane" id="settings">
          <% if current_user %>
            <h3>Learn about <%= @stream.name %></h3>
            <br />
            <%= render :partial => 'streams/flow_list', :locals => { :streams => @stream.sources, :message => ["This stream is currently flowing items from:", ""] } %>

            <%= render :partial => 'streams/flow_list', :locals => { :streams => @stream.targets.where(:user_id => current_user), :message => ["This stream is currently forked into some of your streams:", ""] } %>
          <% else %>
            <p style="padding: 10px 10px 30px 10px; margin-bottom: 20px;"><%= link_to "Sign in", user_session_path %> to fork this stream and start learning!</p>
            <hr />
            <%= render :partial => 'streams/flow_list', :locals => { :streams => @stream.targets, :message => ["This stream is currently forked into the following streams..."] } %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="span8" id="item-area">
    <% unless @stream.pins.empty? %>
      <%= render :partial => 'pins/stream_pin',  :locals => { :pin => @display_pin }  %>
    <% else %>
      <p><%= @stream.user.name %> hasn't added any items to this stream yet!</p>
    <% end %>
  </div>
</div>
